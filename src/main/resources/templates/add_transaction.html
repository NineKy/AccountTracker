<!DOCTYPE html>
<html lang="en">
<head>
    <title>Login V1</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--===============================================================================================-->
    <!--    <link rel="icon" type="image/png" href="/images/icons/favicon.ico"/>-->
    <!--===============================================================================================-->
    <!--    <link rel="stylesheet" type="text/css" href="/vendor/bootstrap/css/bootstrap.min.css">-->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <!--===============================================================================================-->
    <!--    <link rel="stylesheet" type="text/css" href="/fonts/font-awesome-4.7.0/css/font-awesome.min.css">-->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!--===============================================================================================-->
    <!--    <link rel="stylesheet" type="text/css" href="/vendor/animate/animate.css">-->
    <!--===============================================================================================-->
    <!--    <link rel="stylesheet" type="text/css" href="/vendor/css-hamburgers/hamburgers.min.css">-->
    <!--===============================================================================================-->
    <!--    <link rel="stylesheet" type="text/css" href="/vendor/select2/select2.min.css">-->
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="/acb/css/util.css">
    <link rel="stylesheet" type="text/css" href="/acb/css/main.css">
    <!--===============================================================================================-->
</head>
<body>

<div class="limiter">
    <div class="container-login100">
        <div class="my-wrap-login100">
            <form class="login100-form validate-form" onsubmit="recordTran(); return false;">
                <span class="login100-form-title_sub" id = "loginId"></span>
                <span class="login100-form-title_sub">어디에 돈을 쓰셨나요??</span>
                <span id="lastRecorded"></span>


                <div class="wrap-input100 validate-input">
                    <input class="input100" type="text" id="tag" name="tag" placeholder="Select Tag from RIGHT">
                    <input class="input100" type="text" id="tagId" name="tagId" style="display: none">
                    <span class="focus-input100"></span>
                    <span class="symbol-input100">
                        <i class="fa fa-user" aria-hidden="true"></i>
                    </span>
                </div>
                <div style="display: flex; flex-direction: row; justify-content: space-between">
                    <div class="wrap-input100_ver2 validate-input" style="font-size: 14px"> 금액: </div>
                    <div class="wrap-input100_ver2_1 validate-input">
                        <input class="input100" type="text" id="amount" name="amount" placeholder="Amount">
                        <span class="focus-input100"></span>
                        <span class="symbol-input100">
                            <i class="fa fa-user" aria-hidden="true"></i>
                        </span>
                    </div>
                </div>
                <div style="display: flex; flex-direction: row; justify-content: space-between">
                    <div class="wrap-input100_ver2 validate-input" style="font-size: 14px"> 위치: </div>
                    <div class="wrap-input100_ver2_1 validate-input">
                        <input class="input100" type="text" id="usage" name="usage" placeholder="Usage">
                        <span class="focus-input100"></span>
                        <span class="symbol-input100">
                            <i class="fa fa-user" aria-hidden="true"></i>
                        </span>
                    </div>
                </div>
                <div style="display: flex; flex-direction: row; justify-content: space-between">
                    <div class="wrap-input100_ver2 validate-input" style="font-size: 14px"> 내용:</div>
                    <div class="wrap-input100_ver2_1 validate-input">
                        <input class="input100" type="text" id="desc" name="desc" placeholder="Desc">
                        <span class="focus-input100"></span>
                        <span class="symbol-input100">
                            <i class="fa fa-user" aria-hidden="true"></i>
                        </span>
                    </div>
                </div>
                <div style="display: flex; flex-direction: row; justify-content: space-between">
                    <div class="wrap-input100_ver2 validate-input" style="font-size: 14px"> 일자:</div>
                    <div class="wrap-input100_ver2_1 validate-input">
                        <input class="input100" type="text" id="yyyymmdd" name="yyyymmdd" placeholder="$getCurrentYyyymmdd()">
                        <span class="focus-input100"></span>
                        <span class="symbol-input100">
                            <i class="fa fa-user" aria-hidden="true"></i>
                        </span>
                    </div>
                </div>
                <label style="margin-top: 0px">
                    <input type="radio" name="dayy" value="D-1" onchange="getChanged(parseInt(this.value.slice(2)))">
                    D-1
                </label>
                <label></label>
                <label></label>
                <label></label>
                <label></label>
                <label></label>
                <label style="margin-top: 0px">
                    <input type="radio" name="dayy" value="D-2" onchange="getChanged(parseInt(this.value.slice(2)))">
                    D-2
                </label>
                <label></label>
                <label></label>
                <label></label>
                <label></label>
                <label></label>
                <label style="margin-top: 0px">
                    <input type="radio" name="dayy" value="D-3" onchange="getChanged(parseInt(this.value.slice(2)))">
                    D-3
                </label>
                <div class="wrap-input100 validate-input">
                    <!--                    <input class="input100" type="text" id="moneyType" name="moneyType" placeholder="Source From" style="display: none">-->
                    <span class="focus-input100"></span>
                    <span class="symbol-input100">
                        <i class="fa fa-tag" aria-hidden="true"></i>
                    </span>
                    <span class="input100" style="align-items: center; margin-top: 10px">
                        <label style="margin-top: 15px">
                            <input type="radio" name="moneyType" value="FREE">
                            FREE
                        </label>
                        <label></label>
                        <label></label>
                        <label></label>
                        <label></label>
                        <label></label>
                        <label style="margin-top: 15px">
                            <input type="radio" name="moneyType" value="MINE">
                            MINE
                        </label>
                    </span>
                </div>

                <button class="login100-form-sub-btn" onclick="resetInput()" style="text-align: center">
                    <i class="fa fa-long-arrow-right m-l-5" aria-hidden="true"></i>
                    기록중인거 초기화!!
                </button>

                <div class="container-login100-form-btn">
                    <button class="login100-form-btn">
                        저장하기
                    </button>
                </div>
            </form>

            <div class="login100-pic js-tilt" data-tilt style="text-align: center">
                <div style="margin-bottom: 10px;">등록하려는 태그를 선택하세요</div>
                <pre id="resp"></pre>
            </div>

            <!--            return false은 이벤트의 기본 동작을 중지-->
            <div class="text-center p-t-136" style="width: 100%;">
                <a class="txt2" onclick="todayTran()" style="font-size: 20px">
                    <i class="fa fa-long-arrow-right m-l-5" aria-hidden="true" style="font-size: 20px"></i>
                    최근 소비 보기 |
                </a>
                <a class="txt2" onclick="statisticsTran()" style="font-size: 20px">
                    <i class="fa fa-long-arrow-right m-l-5" aria-hidden="true" style="font-size: 20px"></i>
                    통계 보기 |
                </a>
                <a class="txt2" onclick="allTran()" style="font-size: 20px">
                    <i class="fa fa-long-arrow-right m-l-5" aria-hidden="true" style="font-size: 20px"></i>
                    모든 기록 보기
                </a>
            </div>

        </div>
    </div>
</div>

<!--===============================================================================================-->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    document.getElementById('yyyymmdd').placeholder = "yyyymmdd ex)"+getCurrentYyyymmdd();

    window.onload = function () {
        $.ajax({
            url: "/acb/tag/list",
            type: "GET",
            dataType: "json",

            success: function (data) {
                console.log(data);

                data.forEach(function (item) {
                    var roundDiv = document.createElement('div');

                    var iName = document.createElement("i");
                    iName.className = "fa-regular fa-pot-food";

                    var button = document.createElement('button');
                    button.className = 'btn btn-primary';
                    button.style = "width: 316px; text-align: left; margin-top: 5px; margin-bottom: 5px";
                    button.addEventListener('click', function () {
                        $("#tag").val(item.name);
                        $("#tagId").val(item.id);
                    });

                    // madeStr += "TAG(" + item.id + ") : " + item.name + ", 노출색 : " + item.color + "\n";
                    var str = item.name + " | 노출색 : " + item.color + "\n";

                    button.textContent = str;
                    button.style.paddingBottom = "10px";
                    button.appendChild(iName);
                    roundDiv.appendChild(button);

                    $("#resp").append(roundDiv);
                })




            },
            error: function (data) {
                alert("no tags");
            }
        })

        var username = getCookie("userId");
        if(username == null) {
            alert("로그인이 필요합니다");
            location.href = "/acb/view/login";
        }
        document.getElementById("loginId").innerHTML = username + "님 환영합니다";

        $.ajax({
            url: "/acb/transaction/last/recorded/yyyymmdd",
            type: "GET",
            dataType: "json",

            success: function (data) {
                console.log(data);
                if(data == null) {
                    $("#lastRecorded").text("(마지막으로 기록한 날짜가 없습니다)");
                } else {
                    $("#lastRecorded").text("(마지막으로 기록한 날짜 : " + formatDate(data.lastRecordedDay) + ")");
                }
            }
        })
    }


    function getCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    function getSelectedRadioValue(name) {
        var radios = document.getElementsByName(name);
        var selectedValue = null;
        for (var i = 0; i < radios.length; i++) {
            if (radios[i].checked) {
                selectedValue =  radios[i].value;
            }
        }
        if(selectedValue === null){
            alert("돈의 출처를 선택해주셔야 합니다!!");
            throw new Error("돈의 출처를 선택해주셔야 합니다!!")
        }

        return selectedValue;
    }

    function recordTran() {
        $.ajax({
            url: "/acb/transaction",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                "tagId": $("#tagId").val(),
                "amount": $("#amount").val(),
                "title": $("#usage").val(),
                "content": $("#desc").val(),
                "moneyType": getSelectedRadioValue("moneyType"),
                "registeredAtYyyymmdd": $("#yyyymmdd").val(),
                "userId": getCookie("userId")
            }),
            success: function (data) {
                alert("기록 완료! 오늘도 잊지 않고 살아요!");
                resetInput();

            },
            error: function (data) {
                alert("ERROR! CHECK LOG");
                console.log(data)
            }
        })
    }

    function todayTran() {
        window.location.href = '/acb/view/tran/today'
    }

    function statisticsTran() {
        window.location.href = '/acb/view/tran/statistics'
    }

    function allTran() {
        window.location.href = '/acb/view/tran/all'
    }

    function resetInput() {
        document.getElementById("tag").value = "";
        document.getElementById("amount").value = "";
        document.getElementById("usage").value = "";
        document.getElementById("desc").value = "";
        document.getElementById("yyyymmdd").value = "";

        var radios = document.getElementsByName("moneyType");
        for (var i = 0; i < radios.length; i++) {
            if (radios[i].checked) {
                radios[i].checked = false;
            }
        }

        var days = document.getElementsByName("dayy");
        for (var i = 0; i < days.length; i++) {
            if (days[i].checked) {
                days[i].checked = false;
            }
        }
    }

    function getCurrentYyyymmdd() {
        // 현재 날짜 객체 생성
        const currentDate = new Date();

        // 연도, 월, 일 가져오기
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const day = String(currentDate.getDate()).padStart(2, '0');

        // yyyyMMdd 형태로 출력
        const formattedDate = `${year}${month}${day}`;

        return formattedDate;
    }

    function getChanged(days){
        document.getElementById("yyyymmdd").value = (parseInt(getCurrentYyyymmdd()) - days).toString();
    }

    function formatDate(yyyymmdd) {
        const yyyy = yyyymmdd.substr(0, 4);
        const mm = yyyymmdd.substr(4, 2);
        const dd = yyyymmdd.substr(6, 2);
        return `${yyyy} / ${mm} / ${dd}`;
    }
</script>

</body>
</html>